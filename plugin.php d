<?php
/*
Plugin Name:	Custom Functions
Plugin URI:		https://example.com
Description:	Custom Functions by ThePopularizer.
Version:		1.0.0
Author:			ThePopularizer
Author URI:		https://thepopularizer.// COMBAK:
License:		GPL-2.0+
License URI:	http://www.gnu.org/licenses/gpl-2.0.txt

This plugin is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
any later version.

This plugin is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with This plugin. If not, see {URI to Plugin License}.
*/

if ( ! defined( 'WPINC' ) ) {
	die;
}

function include_all_php($folder){ foreach (glob("{$folder}/*.php") as $filename) { include_once $filename; } }
include_all_php(plugin_dir_path( __FILE__ ).'includes'); // Function called for "Includes" diretory
include_all_php(plugin_dir_path( __FILE__ ).'includes/post-types'); // Function called for "Includes" diretory
if ( is_admin() ) {
	include_all_php(plugin_dir_path( __FILE__ ).'includes/admin');
} else {
	include_all_php(plugin_dir_path( __FILE__ ).'includes/front');
}

add_action( 'wp_enqueue_scripts', 'custom_enqueue_files', 20);
/**
 * Loads <list assets here>.
 */
function custom_enqueue_files() {
	// if this is not the front page, abort.
	// if ( ! is_front_page() ) {
	// 	return;
	// }

	// loads a CSS file in the head.
	wp_enqueue_style( 'custom-dynamic-styles', wp_upload_dir()['baseurl'] . '/css/dynamicstyle.css' );

	/**
	 * loads JS files in the footer.
	 */
	wp_enqueue_script( 'custom-scripts', plugin_dir_url( __FILE__ ) . 'js/scripts.js', '', '9.9.0', true );

	// wp_enqueue_script( 'highlightjs-init', plugin_dir_url( __FILE__ ) . 'js/highlight-init.js', '', '1.0.0', true );
}

function google_maps_api($api) {
  $key = get_field('google_maps_api', 'option');
  if (!$key || $key='')  {
	$api['key'] = 'AIzaSyC098A4DGZnwswqxn6SKP442kKc4k8C4a4';
	}
	return $api;
}
add_action('acf/fields/google_map/api', 'google_maps_api');
// add_action('admin_enqueue_scripts', 'google_maps_api');

function google_maps_scripts() {
  $key = get_field('google_maps_api', 'option');
  if (!$key) {
    $key = 'AIzaSyC098A4DGZnwswqxn6SKP442kKc4k8C4a4';
  }
  if ( shortcode_exists('map') ) {
    // wp_enqueue_script( 'google-map-js', 'https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false', array(), '1.0.0', true );
    wp_enqueue_script( 'map-script', 'https://maps.googleapis.com/maps/api/js?key=' . $key, array(), '1.0.0', true );
    // wp_enqueue_script( 'google-map-site-js', plugin_dir_url( __FILE__ ) . 'js/google-maps.js', array(), '1.0.0', true );
  }
}
add_action( 'wp_enqueue_scripts', 'google_maps_scripts' );

// Gutenberg

add_theme_support( 'align-wide' );

// Dynamic CSS

function generate_dynamic_css() {
  $ss_dir = plugin_dir_path( __FILE__ );
  ob_start(); // Capture all output into buffer
  require(plugin_dir_path( __FILE__ ) . 'css/dynamicstyle.php'); // Grab the custom-style.php file
  $css = ob_get_clean(); // Store output in a variable, then flush the buffer
	$css = str_replace('; ',';',str_replace(' }','}',str_replace('{ ','{',str_replace(array("\r\n","\r","\n","\t",'  ','    ','    '),"",preg_replace('!/\*[^*]*\*+([^/][^*]*\*+)*/!','',$css)))));
  file_put_contents(wp_upload_dir()['basedir'] . '/css/dynamicstyle.css', $css, LOCK_EX); // Save it as a css file
}
add_action( 'acf/save_post', 'generate_dynamic_css', 20 ); //Parse the output and write the CSS file on post save (thanks Esmail Ebrahimi)
